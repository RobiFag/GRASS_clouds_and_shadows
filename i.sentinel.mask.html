<h2>DESCRIPTION</h2>
<em>i.sentinel.mask</em> allows to automatically identify clouds and their shadows in Sentinel 2 images. 
<p>
The implemented procedure consists essentially of values thresholds, comparisons and calculations between bands and they lead to two different 
rough maps of clouds and shadows which require further improvements and elaborations (e.g. transformation from raster to vector, cleaning geometries,
 removing small areas, checking topology, etc.) carried out in the different steps of the procedure. 

<table cellspacing="2" cellpadding="2" width="100%" border="0">
	<tbody>
		<tr>
		<td align="center" valign="bottom"><a href="i_sentinel_mask_GWF.png"><img src="i_sentinel_mask_GWF.png" width="100%"></a><br><i>Fig: Module General WorkFlow</i></td>
		<td align="center" valign="bottom"><a href="i_sentinel_mask_CD.png"><img src="i_sentinel_mask_CD.png" width="100%"></a><br><i>Fig: Cloud detection procedure</i></td>
		<td align="center" valign="bottom"><a href="i_sentinel_mask_SD.png"><img src="i_sentinel_mask_SD.png" width="100%"></a><br><i>Fig: Shadow detection procedure</i></td>
		</tr>
	</tbody>
</table>

<p>
The algorithm has been developed starting from rules found in literature (Parmes et. al 2017) and conveniently refined.<br>
Regarding the detection of shadows, some misclassification can occur. Often shadows and water have in fact similar reflectance 
values which can lead to erroneous classification of water bodies as shadows. Therefore, in order to increase the accuracy of 
the final shadow mask, a control check is implemented. Clouds and shadows are spatially intersected in order to remove misclassified areas. 
This means that all those shadow geometries which do not intersect a cloud geometry are removed.

<center>
<img src="i_sentinel_mask_CS.png" width="30%">
<br>
<i>Fig: Module General WorkFlow</i>
</center>
</p>
<p>
At the moment all input bands must be specified by users.
<p>
The final outputs are two different vector maps, one for clouds and one for shadows.
<p>
The metadata file (MTD_TL.xml) is required only if both masks (cloud and shadow)
are computed. The module retrieves from this file the sun azimuth and zenith necessary for the shadow mask cleaning phase 
<em>(see the schema above)<em>
<p>
If flag <b>-s</b> is given all selected bands are rescaled using the specified scale factor [<b>scale_fac</b>=<em>integer</em>]. By default the scale factor is set to 10000, 
the QUANTIFICATION_VALUE from the metadata of Sentinel 2 images.
<p>
The module takes the current region settings into accout. To ignore the current region and set it from the whole image, the flag <b>-r</b> has to be given.
<p>
The module allows to compute only the cloud mask or both cloud and shadow masks. If flag <b>-c</b> is given, only the cloud procedure will be performed. The computation 
of cloud mask is mandatory for shadow mask creation. In fact cloud map is used during the cleaning phase of the shadow mask in order to remove misclassifications.

<h2>SEE ALSO</h2>

<em>
<a href="file:///usr/lib/grass74/docs/html/i.sentinel.download.html">i.sentinel.download</a>,
<a href="file:///usr/lib/grass74/docs/html/i.sentinel.import.html">i.sentinel.download</a>,
<a href="file:///usr/lib/grass74/docs/html/r.import.html">r.import</a>,
<a href="file:///usr/lib/grass74/docs/html/r.extenal.html">r.external</a>
</em>

<h2>AUTHOR</h2>

Roberta Fagandini, Moritz Lennert, Roberto Marzocchi
